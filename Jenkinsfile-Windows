pipeline {
    agent any
    // --- AJOUT DE LA PARTIE 5 : TRIGGERS ---
    triggers {
        // 1. Cron Job : Lancer le build toutes les 5 minutes (si changement détecté)
        cron('H/5 * * * *')
        
        // 2. Webhook : Attendre que GitHub prévienne Jenkins d'un changement
        githubPush()
    }
    environment {
        // --- LA LIGNE MAGIQUE POUR GARDER L'APP EN VIE ---
        BUILD_ID = "dontKillMe"
        
        // Vos autres variables (ne changez pas votre chemin Python qui marche !)
        GLOBAL_PYTHON = "C:\\Program Files\\Python314\\python.exe"
        VENV_DIR = ".venv"
        HOST = "0.0.0.0"
        PORT = "5000"
        APP_MODULE = "app:app"
    }

    stages {
        // ... (Gardez les étapes Checkout, Setup, Test identiques) ...
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/12halima/Jenkins-CI-CD.git',
                    credentialsId: 'github-token'
            }
        }

        stage('Setup Virtual Environment') {
            steps {
                bat """
                    "%GLOBAL_PYTHON%" -m venv ${VENV_DIR}
                    ${VENV_DIR}\\Scripts\\python.exe -m pip install --upgrade pip
                    ${VENV_DIR}\\Scripts\\pip.exe install -r requirements.txt
                    ${VENV_DIR}\\Scripts\\pip.exe install waitress
                """
            }
        }


        stage('Run Tests') {
            when {
                not { changeset 'README.md' }
            }
            parallel {
                stage('Test Lot 1') {
                    steps {
                        bat "${VENV_DIR}\\Scripts\\python.exe -m pytest test_app.py"
                    }
                }
                stage('Test Lot 2') {
                    steps {
                        bat "${VENV_DIR}\\Scripts\\python.exe -m pytest test_app_2.py"
                    }
                }
            }
        }
        stage('Deploy (Local with Waitress)') {
            steps {
                echo 'Demarrage de l application Flask...'
                bat """
                    echo Lancement persistant...
                    start /B ${VENV_DIR}\\Scripts\\waitress-serve.exe --listen=${HOST}:${PORT} ${APP_MODULE} > deploy.log 2>&1
                    
                    echo Pause pour demarrage...
                    "%GLOBAL_PYTHON%" -c "import time; time.sleep(5)"
                """
            }
        }
    }

}
