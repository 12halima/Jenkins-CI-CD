pipeline {
    agent any

    environment {
        // CE CHEMIN FONCTIONNE CHEZ VOUS, NE LE TOUCHEZ PLUS !
        GLOBAL_PYTHON = "C:\\Program Files\\Python314\\python.exe"
        
        VENV_DIR = ".venv"
        HOST = "0.0.0.0"
        PORT = "5000"
        APP_MODULE = "app:app"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/12halima/Jenkins-CI-CD.git',
                    credentialsId: 'github-token'
            }
        }

        stage('Setup Virtual Environment') {
            steps {
                bat """
                    echo 1. Verification Python...
                    "%GLOBAL_PYTHON%" --version
                    
                    echo 2. Creation venv...
                    "%GLOBAL_PYTHON%" -m venv ${VENV_DIR}
                    
                    echo 3. Installation pip...
                    ${VENV_DIR}\\Scripts\\python.exe -m pip install --upgrade pip
                    
                    echo 4. Requirements...
                    ${VENV_DIR}\\Scripts\\pip.exe install -r requirements.txt
                    
                    echo 5. Waitress...
                    ${VENV_DIR}\\Scripts\\pip.exe install waitress
                """
            }
        }

        stage('Run Tests') {
            steps {
                bat """
                    echo Tests...
                    ${VENV_DIR}\\Scripts\\python.exe -m pytest
                """
            }
        }

        stage('Deploy (Local with Waitress)') {
            steps {
                echo 'Demarrage de l application Flask avec Waitress...'
                bat """
                    echo --- Lancement du serveur en arriere-plan ---
                    start /B ${VENV_DIR}\\Scripts\\waitress-serve.exe --listen=${HOST}:${PORT} ${APP_MODULE} > deploy.log 2>&1
                    
                    echo --- Pause de 5 secondes (Version Python sans erreur) ---
                    "%GLOBAL_PYTHON%" -c "import time; time.sleep(5)"
                """
            }
        }
    }
    
    post {
        always {
            echo "Pipeline termine."
        }
        success {
            echo "✅ SUCCES : Tout est vert ! Allez sur http://localhost:5000"
        }
        failure {
            echo "❌ ECHEC : Regardez les logs."
        }
    }
}
